<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RenderChartController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">psi-probe-core</a> &gt; <a href="index.source.html" class="el_package">psiprobe.controllers</a> &gt; <span class="el_source">RenderChartController.java</span></div><h1>RenderChartController.java</h1><pre class="source lang-java linenums">/*
 * Licensed under the GPL License. You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   https://www.gnu.org/licenses/old-licenses/gpl-2.0.html
 *
 * THIS PACKAGE IS PROVIDED &quot;AS IS&quot; AND WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
 * WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE.
 */
package psiprobe.controllers;

import java.awt.BasicStroke;
import java.awt.Color;

import javax.inject.Inject;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.jfree.chart.ChartFactory;
import org.jfree.chart.ChartUtils;
import org.jfree.chart.JFreeChart;
import org.jfree.chart.axis.DateAxis;
import org.jfree.chart.plot.PlotOrientation;
import org.jfree.chart.renderer.xy.XYAreaRenderer;
import org.jfree.chart.ui.RectangleInsets;
import org.jfree.data.xy.DefaultTableXYDataset;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.ServletRequestUtils;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.servlet.ModelAndView;
import org.springframework.web.servlet.mvc.AbstractController;

import psiprobe.Utils;
import psiprobe.beans.stats.providers.SeriesProvider;
import psiprobe.jfreechart.XYLine3DRenderer;
import psiprobe.model.stats.StatsCollection;

/**
 * Plots data from &quot;statsCollection&quot; bean. The data is converted to XYSeries using SeriesProvider,
 * name of which would be passed as a request parameter. The servlet can only plot up to 9 series.
 * It is customizable using these request parameters:
 * &lt;ul&gt;
 * &lt;li&gt;s1c, s2c, ... s9c - Series #i main color&lt;/li&gt;
 * &lt;li&gt;s1o, s2o, ... s9o - Series #i outline color&lt;/li&gt;
 * &lt;li&gt;bc - Chart background color&lt;/li&gt;
 * &lt;li&gt;gc - Chart grid lines color&lt;/li&gt;
 * &lt;li&gt;xl - X axis label&lt;/li&gt;
 * &lt;li&gt;yl - Y axis label&lt;/li&gt;
 * &lt;li&gt;xz - image width&lt;/li&gt;
 * &lt;li&gt;yx - image height&lt;/li&gt;
 * &lt;li&gt;l - show legend (boolean: true|false)&lt;/li&gt;
 * &lt;li&gt;p - name of series provider bean&lt;/li&gt;
 * &lt;/ul&gt;
 */
@Controller
<span class="fc" id="L59">public class RenderChartController extends AbstractController {</span>

  /** The Constant logger. */
<span class="fc" id="L62">  private static final Logger logger = LoggerFactory.getLogger(RenderChartController.class);</span>

  /** The stats collection. */
  @Inject
  private StatsCollection statsCollection;

  /**
   * Gets the stats collection.
   *
   * @return the stats collection
   */
  public StatsCollection getStatsCollection() {
<span class="fc" id="L74">    return statsCollection;</span>
  }

  /**
   * Sets the stats collection.
   *
   * @param statsCollection the new stats collection
   */
  public void setStatsCollection(StatsCollection statsCollection) {
<span class="fc" id="L83">    this.statsCollection = statsCollection;</span>
<span class="fc" id="L84">  }</span>

  @RequestMapping(path = &quot;/chart.png&quot;)
  @Override
  public ModelAndView handleRequest(HttpServletRequest request, HttpServletResponse response)
      throws Exception {
<span class="nc" id="L90">    return super.handleRequest(request, response);</span>
  }

  @Override
  protected ModelAndView handleRequestInternal(HttpServletRequest request,
      HttpServletResponse response) throws Exception {

    // the max number of series
<span class="nc" id="L98">    final int seriesMaxCount = 9;</span>

    // get Series Color from the request
<span class="nc" id="L101">    int[] seriesColor = new int[seriesMaxCount];</span>
<span class="nc" id="L102">    seriesColor[0] = Utils.toIntHex(request.getParameter(&quot;s1c&quot;), 0x9bd2fb);</span>
<span class="nc" id="L103">    seriesColor[1] = Utils.toIntHex(request.getParameter(&quot;s2c&quot;), 0xFF0606);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">    for (int i = 2; i &lt; seriesMaxCount; i++) {</span>
<span class="nc" id="L105">      seriesColor[i] = Utils.toIntHex(request.getParameter(&quot;s&quot; + (i + 1) + &quot;c&quot;), -1);</span>
    }

    // get Series Outline Color from the request
<span class="nc" id="L109">    int[] seriesOutlineColor = new int[seriesMaxCount];</span>
<span class="nc" id="L110">    seriesOutlineColor[0] = Utils.toIntHex(request.getParameter(&quot;s1o&quot;), 0x0665aa);</span>
<span class="nc" id="L111">    seriesOutlineColor[1] = Utils.toIntHex(request.getParameter(&quot;s2o&quot;), 0x9d0000);</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">    for (int i = 2; i &lt; seriesMaxCount; i++) {</span>
<span class="nc" id="L113">      seriesOutlineColor[i] = Utils.toIntHex(request.getParameter(&quot;s&quot; + (i + 1) + &quot;o&quot;), -1);</span>
    }

    // background color
<span class="nc" id="L117">    int backgroundColor = Utils.toIntHex(request.getParameter(&quot;bc&quot;), 0xFFFFFF);</span>

    // grid color
<span class="nc" id="L120">    int gridColor = Utils.toIntHex(request.getParameter(&quot;gc&quot;), 0);</span>

    // X axis title
<span class="nc" id="L123">    String labelX = ServletRequestUtils.getStringParameter(request, &quot;xl&quot;, &quot;&quot;);</span>

    // Y axis title
<span class="nc" id="L126">    String labelY = ServletRequestUtils.getStringParameter(request, &quot;yl&quot;, &quot;&quot;);</span>

    // image width
<span class="nc" id="L129">    int width = ServletRequestUtils.getIntParameter(request, &quot;xz&quot;, 800);</span>

    // image height
<span class="nc" id="L132">    int height = ServletRequestUtils.getIntParameter(request, &quot;yz&quot;, 400);</span>

    // show legend?
<span class="nc" id="L135">    boolean showLegend = ServletRequestUtils.getBooleanParameter(request, &quot;l&quot;, true);</span>

    // Series provider
<span class="nc" id="L138">    String provider = ServletRequestUtils.getStringParameter(request, &quot;p&quot;);</span>

    // Chart type
<span class="nc" id="L141">    String chartType = ServletRequestUtils.getStringParameter(request, &quot;ct&quot;, &quot;area&quot;);</span>

<span class="nc" id="L143">    DefaultTableXYDataset ds = new DefaultTableXYDataset();</span>

<span class="nc bnc" id="L145" title="All 2 branches missed.">    if (provider != null) {</span>
<span class="nc" id="L146">      Object series = getApplicationContext().getBean(provider);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">      if (series instanceof SeriesProvider) {</span>
<span class="nc" id="L148">        ((SeriesProvider) series).populate(ds, statsCollection, request);</span>
      } else {
<span class="nc" id="L150">        logger.error(&quot;SeriesProvider '{}' does not implement '{}'&quot;, provider, SeriesProvider.class);</span>
      }
    }

    // Build series data from the give statistic
<span class="nc" id="L155">    JFreeChart chart = null;</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">    if (&quot;area&quot;.equals(chartType)) {</span>
<span class="nc" id="L157">      chart = ChartFactory.createXYAreaChart(&quot;&quot;, labelX, labelY, ds, PlotOrientation.VERTICAL,</span>
          showLegend, false, false);

<span class="nc" id="L160">      ((XYAreaRenderer) chart.getXYPlot().getRenderer()).setOutline(true);</span>

<span class="nc bnc" id="L162" title="All 2 branches missed.">    } else if (&quot;stacked&quot;.equals(chartType)) {</span>
<span class="nc" id="L163">      chart = ChartFactory.createStackedXYAreaChart(&quot;&quot;, labelX, labelY, ds,</span>
          PlotOrientation.VERTICAL, showLegend, false, false);

<span class="nc bnc" id="L166" title="All 2 branches missed.">    } else if (&quot;line&quot;.equals(chartType)) {</span>
<span class="nc" id="L167">      chart = ChartFactory.createXYLineChart(&quot;&quot;, labelX, labelY, ds, PlotOrientation.VERTICAL,</span>
          showLegend, false, false);

<span class="nc" id="L170">      final XYLine3DRenderer renderer = new XYLine3DRenderer();</span>
<span class="nc" id="L171">      renderer.setDrawOutlines(true);</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">      for (int i = 0; i &lt; seriesMaxCount; i++) {</span>
<span class="nc" id="L173">        renderer.setSeriesLinesVisible(i, true);</span>
<span class="nc" id="L174">        renderer.setSeriesShapesVisible(i, true);</span>
<span class="nc" id="L175">        renderer.setSeriesStroke(i, new BasicStroke(2));</span>
      }
<span class="nc" id="L177">      renderer.setXOffset(1);</span>
<span class="nc" id="L178">      renderer.setYOffset(1);</span>
<span class="nc" id="L179">      chart.getXYPlot().setRenderer(renderer);</span>
    }

<span class="nc bnc" id="L182" title="All 2 branches missed.">    if (chart != null) {</span>
<span class="nc" id="L183">      chart.setAntiAlias(true);</span>
<span class="nc" id="L184">      chart.setBackgroundPaint(new Color(backgroundColor));</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">      for (int i = 0; i &lt; seriesMaxCount; i++) {</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (seriesColor[i] &gt;= 0) {</span>
<span class="nc" id="L187">          chart.getXYPlot().getRenderer().setSeriesPaint(i, new Color(seriesColor[i]));</span>
        }
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (seriesOutlineColor[i] &gt;= 0) {</span>
<span class="nc" id="L190">          chart.getXYPlot().getRenderer().setSeriesOutlinePaint(i,</span>
              new Color(seriesOutlineColor[i]));
        }
      }
<span class="nc" id="L194">      chart.getXYPlot().setDomainGridlinePaint(new Color(gridColor));</span>
<span class="nc" id="L195">      chart.getXYPlot().setRangeGridlinePaint(new Color(gridColor));</span>
<span class="nc" id="L196">      chart.getXYPlot().setDomainAxis(0, new DateAxis());</span>
<span class="nc" id="L197">      chart.getXYPlot().setDomainAxis(1, new DateAxis());</span>
<span class="nc" id="L198">      chart.getXYPlot().setInsets(new RectangleInsets(-15, 0, 0, 10));</span>

<span class="nc" id="L200">      response.setHeader(&quot;Content-type&quot;, &quot;image/png&quot;);</span>
<span class="nc" id="L201">      response.getOutputStream()</span>
<span class="nc" id="L202">          .write(ChartUtils.encodeAsPNG(chart.createBufferedImage(width, height)));</span>
    }

<span class="nc" id="L205">    return null;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>