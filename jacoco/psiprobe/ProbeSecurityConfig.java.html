<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProbeSecurityConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">psi-probe-core</a> &gt; <a href="index.source.html" class="el_package">psiprobe</a> &gt; <span class="el_source">ProbeSecurityConfig.java</span></div><h1>ProbeSecurityConfig.java</h1><pre class="source lang-java linenums">/*
 * Licensed under the GPL License. You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   https://www.gnu.org/licenses/old-licenses/gpl-2.0.html
 *
 * THIS PACKAGE IS PROVIDED &quot;AS IS&quot; AND WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
 * WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE.
 */
package psiprobe;

import com.thoughtworks.xstream.XStream;
import com.thoughtworks.xstream.security.NoTypePermission;
import com.thoughtworks.xstream.security.NullPermission;
import com.thoughtworks.xstream.security.PrimitiveTypePermission;

import java.util.ArrayList;
import java.util.Collection;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.TreeMap;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.access.AccessDecisionVoter;
import org.springframework.security.access.ConfigAttribute;
import org.springframework.security.access.SecurityConfig;
import org.springframework.security.access.vote.AffirmativeBased;
import org.springframework.security.access.vote.RoleVoter;
import org.springframework.security.authentication.AuthenticationProvider;
import org.springframework.security.authentication.ProviderManager;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.core.authority.mapping.SimpleAttributes2GrantedAuthoritiesMapper;
import org.springframework.security.web.DefaultSecurityFilterChain;
import org.springframework.security.web.FilterChainProxy;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.access.ExceptionTranslationFilter;
import org.springframework.security.web.access.intercept.DefaultFilterInvocationSecurityMetadataSource;
import org.springframework.security.web.access.intercept.FilterSecurityInterceptor;
import org.springframework.security.web.authentication.Http403ForbiddenEntryPoint;
import org.springframework.security.web.authentication.logout.LogoutFilter;
import org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler;
import org.springframework.security.web.authentication.preauth.PreAuthenticatedAuthenticationProvider;
import org.springframework.security.web.authentication.preauth.PreAuthenticatedGrantedAuthoritiesUserDetailsService;
import org.springframework.security.web.authentication.preauth.j2ee.J2eeBasedPreAuthenticatedWebAuthenticationDetailsSource;
import org.springframework.security.web.authentication.preauth.j2ee.J2eePreAuthenticatedProcessingFilter;
import org.springframework.security.web.authentication.preauth.j2ee.WebXmlMappableAttributesRetriever;
import org.springframework.security.web.context.SecurityContextPersistenceFilter;
import org.springframework.security.web.savedrequest.HttpSessionRequestCache;
import org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter;
import org.springframework.security.web.util.matcher.AntPathRequestMatcher;
import org.springframework.security.web.util.matcher.RequestMatcher;

/**
 * The Class ProbeSecurityConfig.
 */
@Configuration
@EnableWebSecurity
<span class="fc" id="L60">public class ProbeSecurityConfig {</span>

  /**
   * Gets the filter chain proxy.
   *
   * @return the filter chain proxy
   */
  @Bean(name = &quot;filterChainProxy&quot;)
  public FilterChainProxy getFilterChainProxy() {
<span class="fc" id="L69">    SecurityFilterChain chain = new DefaultSecurityFilterChain(new AntPathRequestMatcher(&quot;/**&quot;),</span>
<span class="fc" id="L70">        getSecurityContextPersistenceFilter(), getJ2eePreAuthenticatedProcessingFilter(),</span>
<span class="fc" id="L71">        getLogoutFilter(), getExceptionTranslationFilter(), getFilterSecurityInterceptor());</span>
<span class="fc" id="L72">    return new FilterChainProxy(chain);</span>
  }

  /**
   * Gets the provider manager.
   *
   * @return the provider manager
   */
  @Bean(name = &quot;authenticationManager&quot;)
  public ProviderManager getProviderManager() {
<span class="fc" id="L82">    List&lt;AuthenticationProvider&gt; providers = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L83">    providers.add(getPreAuthenticatedAuthenticationProvider());</span>
<span class="fc" id="L84">    return new ProviderManager(providers);</span>
  }

  /**
   * Gets the security context persistence filter.
   *
   * @return the security context persistence filter
   */
  @Bean(name = &quot;securityContextPersistenceFilter&quot;)
  public SecurityContextPersistenceFilter getSecurityContextPersistenceFilter() {
<span class="fc" id="L94">    return new SecurityContextPersistenceFilter();</span>
  }

  /**
   * Gets the pre authenticated authentication provider.
   *
   * @return the pre authenticated authentication provider
   */
  @Bean(name = &quot;preAuthenticatedAuthenticationProvider&quot;)
  public PreAuthenticatedAuthenticationProvider getPreAuthenticatedAuthenticationProvider() {
<span class="fc" id="L104">    PreAuthenticatedAuthenticationProvider provider = new PreAuthenticatedAuthenticationProvider();</span>
<span class="fc" id="L105">    provider.setPreAuthenticatedUserDetailsService(</span>
<span class="fc" id="L106">        getPreAuthenticatedGrantedAuthoritiesUserDetailsService());</span>
<span class="fc" id="L107">    return provider;</span>
  }

  /**
   * Gets the pre authenticated granted authorities user details service.
   *
   * @return the pre authenticated granted authorities user details service
   */
  @Bean(name = &quot;preAuthenticatedGrantedAuthoritiesUserDetailsService&quot;)
  public PreAuthenticatedGrantedAuthoritiesUserDetailsService getPreAuthenticatedGrantedAuthoritiesUserDetailsService() {
<span class="fc" id="L117">    return new PreAuthenticatedGrantedAuthoritiesUserDetailsService();</span>
  }

  /**
   * Gets the j 2 ee pre authenticated processing filter.
   *
   * @return the j 2 ee pre authenticated processing filter
   */
  @Bean(name = &quot;j2eePreAuthenticatedProcessingFilter&quot;)
  public J2eePreAuthenticatedProcessingFilter getJ2eePreAuthenticatedProcessingFilter() {
<span class="fc" id="L127">    J2eePreAuthenticatedProcessingFilter filter = new J2eePreAuthenticatedProcessingFilter();</span>
<span class="fc" id="L128">    filter.setAuthenticationManager(getProviderManager());</span>
<span class="fc" id="L129">    filter.setAuthenticationDetailsSource(</span>
<span class="fc" id="L130">        getJ2eeBasedPreAuthenticatedWebAuthenticationDetailsSource());</span>
<span class="fc" id="L131">    return filter;</span>
  }

  /**
   * Gets the http 403 forbidden entry point.
   *
   * @return the http 403 forbidden entry point
   */
  @Bean(name = &quot;http403ForbiddenEntryPoint&quot;)
  public Http403ForbiddenEntryPoint getHttp403ForbiddenEntryPoint() {
<span class="fc" id="L141">    return new Http403ForbiddenEntryPoint();</span>
  }

  /**
   * Gets the logout filter.
   *
   * @return the logout filter
   */
  @Bean(name = &quot;logoutFilter&quot;)
  public LogoutFilter getLogoutFilter() {
<span class="fc" id="L151">    return new LogoutFilter(&quot;/&quot;, getSecurityContextLogoutHandler());</span>
  }

  /**
   * Gets the security context logout handler.
   *
   * @return the security context logout handler
   */
  @Bean(name = &quot;securityContextLogoutHandler&quot;)
  public SecurityContextLogoutHandler getSecurityContextLogoutHandler() {
<span class="fc" id="L161">    return new SecurityContextLogoutHandler();</span>
  }

  /**
   * Gets the j 2 ee based pre authenticated web authentication details source.
   *
   * @return the j 2 ee based pre authenticated web authentication details source
   */
  @Bean(name = &quot;j2eeBasedPreAuthenticatedWebAuthenticationDetailsSource&quot;)
  public J2eeBasedPreAuthenticatedWebAuthenticationDetailsSource getJ2eeBasedPreAuthenticatedWebAuthenticationDetailsSource() {
<span class="fc" id="L171">    J2eeBasedPreAuthenticatedWebAuthenticationDetailsSource source =</span>
        new J2eeBasedPreAuthenticatedWebAuthenticationDetailsSource();
<span class="fc" id="L173">    source.setMappableRolesRetriever(getWebXmlMappableAttributesRetriever());</span>
<span class="fc" id="L174">    source.setUserRoles2GrantedAuthoritiesMapper(getSimpleAttributes2GrantedAuthoritiesMapper());</span>
<span class="fc" id="L175">    return source;</span>
  }

  /**
   * Gets the simple attributes 2 granted authorities mapper.
   *
   * @return the simple attributes 2 granted authorities mapper
   */
  @Bean(name = &quot;simpleAttributes2GrantedAuthoritiesMapper&quot;)
  public SimpleAttributes2GrantedAuthoritiesMapper getSimpleAttributes2GrantedAuthoritiesMapper() {
<span class="fc" id="L185">    SimpleAttributes2GrantedAuthoritiesMapper mapper =</span>
        new SimpleAttributes2GrantedAuthoritiesMapper();
<span class="fc" id="L187">    mapper.setConvertAttributeToUpperCase(true);</span>
<span class="fc" id="L188">    return mapper;</span>
  }

  /**
   * Gets the web xml mappable attributes retriever.
   *
   * @return the web xml mappable attributes retriever
   */
  @Bean(name = &quot;webXmlMappableAttributesRetriever&quot;)
  public WebXmlMappableAttributesRetriever getWebXmlMappableAttributesRetriever() {
<span class="fc" id="L198">    return new WebXmlMappableAttributesRetriever();</span>
  }

  /**
   * Gets the exception translation filter.
   *
   * @return the exception translation filter
   */
  @Bean(name = &quot;exceptionTranslationFilter&quot;)
  public ExceptionTranslationFilter getExceptionTranslationFilter() {
<span class="fc" id="L208">    return new ExceptionTranslationFilter(getHttp403ForbiddenEntryPoint());</span>
  }

  /**
   * Gets the affirmative based.
   *
   * @return the affirmative based
   */
  @Bean(name = &quot;affirmativeBased&quot;)
  public AffirmativeBased getAffirmativeBased() {
<span class="fc" id="L218">    List&lt;AccessDecisionVoter&lt;? extends Object&gt;&gt; decisionVoters = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L219">    decisionVoters.add(getRoleVoter());</span>

<span class="fc" id="L221">    AffirmativeBased based = new AffirmativeBased(decisionVoters);</span>
<span class="fc" id="L222">    based.setAllowIfAllAbstainDecisions(false);</span>
<span class="fc" id="L223">    return based;</span>
  }

  /**
   * Gets the filter security interceptor.
   *
   * @return the filter security interceptor
   */
  @Bean(name = &quot;filterSecurityInterceptor&quot;)
  public FilterSecurityInterceptor getFilterSecurityInterceptor() {
<span class="fc" id="L233">    FilterSecurityInterceptor interceptor = new FilterSecurityInterceptor();</span>
<span class="fc" id="L234">    interceptor.setAuthenticationManager(getProviderManager());</span>
<span class="fc" id="L235">    interceptor.setAccessDecisionManager(getAffirmativeBased());</span>

<span class="fc" id="L237">    LinkedHashMap&lt;RequestMatcher, Collection&lt;ConfigAttribute&gt;&gt; requestMap = new LinkedHashMap&lt;&gt;();</span>
<span class="fc" id="L238">    requestMap.put(new AntPathRequestMatcher(&quot;/adm/**&quot;),</span>
<span class="fc" id="L239">        SecurityConfig.createListFromCommaDelimitedString(&quot;ROLE_MANAGER,ROLE_MANAGER-GUI&quot;));</span>
<span class="fc" id="L240">    requestMap.put(new AntPathRequestMatcher(&quot;/adm/restartvm.ajax&quot;), SecurityConfig</span>
<span class="fc" id="L241">        .createListFromCommaDelimitedString(&quot;ROLE_POWERUSERPLUS,ROLE_MANAGER,ROLE_MANAGER-GUI&quot;));</span>
<span class="fc" id="L242">    requestMap.put(new AntPathRequestMatcher(&quot;/sql/**&quot;), SecurityConfig</span>
<span class="fc" id="L243">        .createListFromCommaDelimitedString(&quot;ROLE_POWERUSERPLUS,ROLE_MANAGER,ROLE_MANAGER-GUI&quot;));</span>
<span class="fc" id="L244">    requestMap.put(new AntPathRequestMatcher(&quot;/app/**&quot;),</span>
<span class="fc" id="L245">        SecurityConfig.createListFromCommaDelimitedString(</span>
            &quot;ROLE_POWERUSER,ROLE_POWERUSERPLUS,ROLE_MANAGER,ROLE_MANAGER-GUI&quot;));
<span class="fc" id="L247">    requestMap.put(new AntPathRequestMatcher(&quot;/**&quot;),</span>
<span class="fc" id="L248">        SecurityConfig.createListFromCommaDelimitedString(</span>
            &quot;ROLE_PROBEUSER,ROLE_POWERUSER,ROLE_POWERUSERPLUS,ROLE_MANAGER,ROLE_MANAGER-GUI&quot;));

<span class="fc" id="L251">    interceptor</span>
<span class="fc" id="L252">        .setSecurityMetadataSource(new DefaultFilterInvocationSecurityMetadataSource(requestMap));</span>
<span class="fc" id="L253">    return interceptor;</span>
  }

  /**
   * Gets the role voter.
   *
   * @return the role voter
   */
  @Bean(name = &quot;roleVoter&quot;)
  public RoleVoter getRoleVoter() {
<span class="fc" id="L263">    return new RoleVoter();</span>
  }

  /**
   * Gets the security context holder aware request filter.
   *
   * @return the security context holder aware request filter
   */
  @Bean(name = &quot;securityContextHolderAwareRequestFilter&quot;)
  public SecurityContextHolderAwareRequestFilter getSecurityContextHolderAwareRequestFilter() {
<span class="fc" id="L273">    return new SecurityContextHolderAwareRequestFilter();</span>
  }

  /**
   * Gets the http session request cache.
   *
   * @return the http session request cache
   */
  @Bean(name = &quot;httpSessionRequestCache&quot;)
  public HttpSessionRequestCache getHttpSessionRequestCache() {
<span class="fc" id="L283">    HttpSessionRequestCache cache = new HttpSessionRequestCache();</span>
<span class="fc" id="L284">    cache.setCreateSessionAllowed(false);</span>
<span class="fc" id="L285">    return cache;</span>
  }

  /**
   * Gets the xstream.
   *
   * @return the xstream
   */
  @Bean(name = &quot;xstream&quot;)
  public XStream getXstream() {
<span class="fc" id="L295">    XStream xstream = new XStream();</span>
    // clear out existing permissions and start a whitelist
<span class="fc" id="L297">    xstream.addPermission(NoTypePermission.NONE);</span>
    // allow some basics
<span class="fc" id="L299">    xstream.addPermission(NullPermission.NULL);</span>
<span class="fc" id="L300">    xstream.addPermission(PrimitiveTypePermission.PRIMITIVES);</span>
<span class="fc" id="L301">    xstream.allowTypeHierarchy(Collection.class);</span>
<span class="fc" id="L302">    xstream.allowTypeHierarchy(String.class);</span>
<span class="fc" id="L303">    xstream.allowTypeHierarchy(TreeMap.class);</span>
<span class="fc" id="L304">    xstream.allowTypesByWildcard(new String[] {&quot;org.jfree.data.xy.**&quot;, &quot;psiprobe.controllers.**&quot;,</span>
        &quot;psiprobe.model.**&quot;, &quot;psiprobe.model.stats.**&quot;});
<span class="fc" id="L306">    return xstream;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>