<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Tokenizer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">psi-probe-core</a> &gt; <a href="index.source.html" class="el_package">psiprobe.tokenizer</a> &gt; <span class="el_source">Tokenizer.java</span></div><h1>Tokenizer.java</h1><pre class="source lang-java linenums">/*
 * Licensed under the GPL License. You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   https://www.gnu.org/licenses/old-licenses/gpl-2.0.html
 *
 * THIS PACKAGE IS PROVIDED &quot;AS IS&quot; AND WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
 * WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE.
 */
package psiprobe.tokenizer;

import java.io.IOException;
import java.io.Reader;
import java.util.Collections;
import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * The Class Tokenizer.
 */
public class Tokenizer {

  /** The Constant logger. */
<span class="nc" id="L27">  private static final Logger logger = LoggerFactory.getLogger(Tokenizer.class);</span>

  /** The Constant TT_TOKEN. */
  public static final int TT_TOKEN = 0;

  /** The Constant TT_SYMBOL. */
  public static final int TT_SYMBOL = 1;

  /** The Constant TT_BLOCK. */
  public static final int TT_BLOCK = 2;

  /** The Constant TT_ERROR. */
  public static final int TT_ERROR = 3;

  /** The reader. */
  private Reader reader;

  /** The symbols. */
  private final List&lt;TokenizerSymbol&gt; symbols;

  /** The push count. */
  private int pushCount;

  /** The token. */
  private final TokenizerToken token;

  /** The upcoming token. */
  private final TokenizerToken upcomingToken;

  /** The cache position. */
  private int cachePosition;

  /** The cache size. */
  private int cacheSize;

  /** The cache buffer. */
  private final char[] cacheBuffer;

  /** The cache pin position. */
  private int cachePinPosition;

  /**
   * Instantiates a new tokenizer.
   */
  public Tokenizer() {
<span class="nc" id="L72">    this(null, 4096);</span>
<span class="nc" id="L73">  }</span>

  /**
   * Instantiates a new tokenizer.
   *
   * @param reader the reader
   */
  public Tokenizer(Reader reader) {
<span class="nc" id="L81">    this(reader, 4096);</span>
<span class="nc" id="L82">  }</span>

  /**
   * Instantiates a new tokenizer.
   *
   * @param reader the reader
   * @param cacheBufferSize the cache buffer size
   */
<span class="nc" id="L90">  public Tokenizer(Reader reader, int cacheBufferSize) {</span>
<span class="nc" id="L91">    symbols = new UniqueList&lt;&gt;();</span>
<span class="nc" id="L92">    token = new TokenizerToken();</span>
<span class="nc" id="L93">    upcomingToken = new TokenizerToken();</span>
<span class="nc" id="L94">    cacheBuffer = new char[cacheBufferSize];</span>
<span class="nc" id="L95">    setReader(reader);</span>
<span class="nc" id="L96">  }</span>

  /**
   * Load cache.
   *
   * @param count the count
   *
   * @throws IOException Signals that an I/O exception has occurred.
   */
  private void loadCache(int count) throws IOException {
<span class="nc bnc" id="L106" title="All 2 branches missed.">    int charToRead = count == 0 ? 0 : count - 1;</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">    if (cachePosition + charToRead &gt;= cacheSize) {</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">      if (cacheSize == 0) {</span>
<span class="nc" id="L109">        cacheSize = reader.read(cacheBuffer, 0, cacheBuffer.length);</span>
<span class="nc" id="L110">        cachePosition = 0;</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">      } else if (cacheSize == cacheBuffer.length) {</span>
        // make sure we do not read beyond the stream
<span class="nc" id="L113">        int halfCacheSize = cacheSize / 2;</span>
        // copy the lower half into the upper half
<span class="nc" id="L115">        System.arraycopy(cacheBuffer, halfCacheSize, cacheBuffer, 0, halfCacheSize);</span>
<span class="nc" id="L116">        cachePosition -= halfCacheSize;</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (cachePinPosition != -1) {</span>
<span class="nc" id="L118">          cachePinPosition -= halfCacheSize;</span>
        }

<span class="nc" id="L121">        int charsRead = reader.read(cacheBuffer, halfCacheSize, cacheSize - halfCacheSize);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">        if (charsRead == -1) {</span>
<span class="nc" id="L123">          cacheSize = halfCacheSize;</span>
        } else {
<span class="nc" id="L125">          cacheSize = charsRead + halfCacheSize;</span>
        }
      }
    }
<span class="nc" id="L129">  }</span>

  /**
   * Gets the token.
   *
   * @return the token
   *
   * @throws IOException Signals that an I/O exception has occurred.
   */
  public Token getToken() throws IOException {
<span class="nc bnc" id="L139" title="All 2 branches missed.">    if (token.type == Tokenizer.TT_ERROR) {</span>
<span class="nc" id="L140">      return nextToken();</span>
    }
<span class="nc" id="L142">    return token;</span>
  }

  /**
   * Next token.
   *
   * @return the token
   *
   * @throws IOException Signals that an I/O exception has occurred.
   */
  public Token nextToken() throws IOException {
<span class="nc bnc" id="L153" title="All 2 branches missed.">    if (pushCount &gt; 0) {</span>
<span class="nc" id="L154">      pushCount--;</span>
<span class="nc" id="L155">      return token;</span>
    }
<span class="nc bnc" id="L157" title="All 2 branches missed.">    if (upcomingToken.type != Tokenizer.TT_ERROR) {</span>
<span class="nc" id="L158">      token.assign(upcomingToken);</span>
<span class="nc" id="L159">      upcomingToken.type = Tokenizer.TT_ERROR;</span>
<span class="nc" id="L160">      return token;</span>
    }

<span class="nc" id="L163">    token.init();</span>
<span class="nc" id="L164">    char[] chr = new char[1];</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">    while (hasMore()) {</span>
<span class="nc" id="L166">      read(chr, 1);</span>

<span class="nc" id="L168">      int symbolIndex = lookupSymbol(chr[0]);</span>

<span class="nc bnc" id="L170" title="All 2 branches missed.">      if (symbolIndex != -1) {</span>
        // we have found a symbol
        TokenizerToken workToken =
<span class="nc bnc" id="L173" title="All 4 branches missed.">            token.type == Tokenizer.TT_TOKEN &amp;&amp; token.text.length() &gt; 0 ? upcomingToken : token;</span>
<span class="nc" id="L174">        TokenizerSymbol symbol = symbols.get(symbolIndex);</span>
<span class="nc" id="L175">        boolean hideSymbol = symbol.hidden;</span>

<span class="nc bnc" id="L177" title="All 2 branches missed.">        if (!hideSymbol) {</span>
<span class="nc" id="L178">          workToken.init();</span>
<span class="nc" id="L179">          workToken.text.append(symbol.startText);</span>
<span class="nc" id="L180">          workToken.type = Tokenizer.TT_SYMBOL;</span>
<span class="nc" id="L181">          workToken.name = symbol.name;</span>
        }

<span class="nc bnc" id="L184" title="All 2 branches missed.">        if (symbol.tailText != null) {</span>
          // the symbol is a block, look for the tailText
<span class="nc bnc" id="L186" title="All 4 branches missed.">          while (hasMore() &amp;&amp; !compare(symbol.tailText.toCharArray(), 0)) {</span>
<span class="nc" id="L187">            read(chr, 1);</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">            if (!hideSymbol) {</span>
<span class="nc" id="L189">              workToken.text.append(chr);</span>
<span class="nc" id="L190">              workToken.innerText.append(chr);</span>
            }
          }

<span class="nc bnc" id="L194" title="All 2 branches missed.">          if (!hideSymbol) {</span>
<span class="nc" id="L195">            workToken.text.append(symbol.tailText);</span>
          }
<span class="nc" id="L197">          workToken.type = Tokenizer.TT_BLOCK;</span>
        }

<span class="nc bnc" id="L200" title="All 2 branches missed.">        if (token.text.length() &gt; 0) {</span>
<span class="nc" id="L201">          break;</span>
        }
<span class="nc" id="L203">      } else {</span>
<span class="nc" id="L204">        token.text.append(chr);</span>
<span class="nc" id="L205">        token.type = Tokenizer.TT_TOKEN;</span>
      }
<span class="nc" id="L207">    }</span>
<span class="nc" id="L208">    return token;</span>
  }

  /**
   * Push back.
   */
  public void pushBack() {
<span class="nc" id="L215">    pushCount++;</span>
<span class="nc" id="L216">  }</span>

  /**
   * Sets the reader.
   *
   * @param reader the new reader
   */
  public void setReader(Reader reader) {
<span class="nc" id="L224">    this.reader = reader;</span>
<span class="nc" id="L225">    cachePosition = 0;</span>
<span class="nc" id="L226">    cachePinPosition = -1;</span>
<span class="nc" id="L227">    cacheSize = 0;</span>
<span class="nc" id="L228">    token.type = TT_ERROR;</span>
<span class="nc" id="L229">    upcomingToken.type = TT_ERROR;</span>
<span class="nc" id="L230">  }</span>

  /**
   * Compare.
   *
   * @param chars the chars
   * @param offs the offs
   *
   * @return true, if successful
   *
   * @throws IOException Signals that an I/O exception has occurred.
   */
  private boolean compare(char[] chars, int offs) throws IOException {
<span class="nc" id="L243">    char[] subStr = new char[chars.length - offs];</span>
<span class="nc" id="L244">    cachePinPosition = cachePosition;</span>
<span class="nc" id="L245">    read(subStr, subStr.length);</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">    for (int i = 0; i &lt; subStr.length; i++) {</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">      if (subStr[i] != chars[i + offs]) {</span>
<span class="nc" id="L248">        cachePosition = cachePinPosition;</span>
<span class="nc" id="L249">        cachePinPosition = -1;</span>
<span class="nc" id="L250">        return false;</span>
      }
    }
<span class="nc" id="L253">    return true;</span>
  }

  /**
   * Lookup symbol.
   *
   * @param chr the chr
   *
   * @return the int
   *
   * @throws IOException Signals that an I/O exception has occurred.
   */
  private int lookupSymbol(char chr) throws IOException {
<span class="nc" id="L266">    int result = -1;</span>

<span class="nc" id="L268">    Character chrObj = chr;</span>
<span class="nc" id="L269">    int index = Collections.binarySearch(symbols, chrObj);</span>

<span class="nc bnc" id="L271" title="All 2 branches missed.">    if (index &gt;= 0) {</span>
      // the index could be anywhere within a group of symbols with the same first letter
      // so we need to scroll up the group to make sure we start test from the beginning
<span class="nc bnc" id="L274" title="All 4 branches missed.">      while (index &gt; 0 &amp;&amp; symbols.get(index - 1).compareTo(chrObj) == 0) {</span>
<span class="nc" id="L275">        index--;</span>
      }
<span class="nc bnc" id="L277" title="All 2 branches missed.">      while (index &lt; symbols.size()) {</span>
<span class="nc" id="L278">        TokenizerSymbol symbol = symbols.get(index);</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">        if (symbol.compareTo(chrObj) != 0) {</span>
<span class="nc" id="L280">          break;</span>
        }
<span class="nc bnc" id="L282" title="All 2 branches missed.">        if (compare(symbol.startText.toCharArray(), 1)) {</span>
<span class="nc" id="L283">          result = index;</span>
<span class="nc" id="L284">          break;</span>
        }
<span class="nc" id="L286">        index++;</span>
<span class="nc" id="L287">      }</span>
    }
<span class="nc" id="L289">    return result;</span>
  }

  /**
   * Read.
   *
   * @param chrs the chrs
   * @param count the count
   *
   * @throws IOException Signals that an I/O exception has occurred.
   */
  private void read(char[] chrs, int count) throws IOException {
<span class="nc" id="L301">    loadCache(count);</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">    int endPoint = cachePosition + count - 1 &gt;= cacheSize ? cacheSize : cachePosition + count - 1;</span>
<span class="nc bnc" id="L303" title="All 2 branches missed.">    if (cachePosition &lt;= endPoint) {</span>
<span class="nc" id="L304">      System.arraycopy(cacheBuffer, cachePosition, chrs, 0, endPoint - cachePosition + 1);</span>
    }
<span class="nc" id="L306">    cachePosition = endPoint + 1;</span>
<span class="nc" id="L307">  }</span>

  /**
   * Checks for more.
   *
   * @return true, if successful
   *
   * @throws IOException Signals that an I/O exception has occurred.
   */
  public boolean hasMore() throws IOException {
<span class="nc" id="L317">    loadCache(0);</span>
<span class="nc bnc" id="L318" title="All 6 branches missed.">    return cachePosition &lt; cacheSize || upcomingToken.type != Tokenizer.TT_ERROR || pushCount &gt; 0;</span>
  }

  /**
   * Adds the symbol.
   *
   * @param text the text
   */
  public void addSymbol(String text) {
<span class="nc" id="L327">    symbols.add(new TokenizerSymbol(null, text, null, false, false, true, false));</span>
<span class="nc" id="L328">  }</span>

  /**
   * Adds the symbol.
   *
   * @param text the text
   * @param hidden the hidden
   */
  public void addSymbol(String text, boolean hidden) {
<span class="nc" id="L337">    symbols.add(new TokenizerSymbol(null, text, null, hidden, false, true, false));</span>
<span class="nc" id="L338">  }</span>

  /**
   * Adds the symbol.
   *
   * @param startText the start text
   * @param endText the end text
   * @param hidden the hidden
   */
  public void addSymbol(String startText, String endText, boolean hidden) {
<span class="nc" id="L348">    symbols.add(new TokenizerSymbol(null, startText, endText, hidden, false, true, false));</span>
<span class="nc" id="L349">  }</span>

  /**
   * Adds the symbol.
   *
   * @param symbol the symbol
   */
  public void addSymbol(TokenizerSymbol symbol) {
<span class="nc" id="L357">    symbols.add(symbol);</span>
<span class="nc" id="L358">  }</span>

  /**
   * Gets the next string.
   *
   * @param defaultValue the default value
   *
   * @return the next string
   *
   * @throws IOException Signals that an I/O exception has occurred.
   */
  public String getNextString(String defaultValue) throws IOException {
<span class="nc bnc" id="L370" title="All 2 branches missed.">    return hasMore() ? nextToken().getInnerText() : defaultValue;</span>
  }

  /**
   * Gets the next boolean.
   *
   * @param trueValue the true value
   * @param defaultValue the default value
   *
   * @return the next boolean
   *
   * @throws IOException Signals that an I/O exception has occurred.
   */
  public boolean getNextBoolean(String trueValue, boolean defaultValue) throws IOException {
<span class="nc bnc" id="L384" title="All 2 branches missed.">    return hasMore() ? trueValue.equalsIgnoreCase(nextToken().getInnerText()) : defaultValue;</span>
  }

  /**
   * Gets the next long.
   *
   * @param defaultValue the default value
   *
   * @return the next long
   *
   * @throws IOException Signals that an I/O exception has occurred.
   */
  public long getNextLong(long defaultValue) throws IOException {
<span class="nc" id="L397">    String stval = getNextString(null);</span>

<span class="nc bnc" id="L399" title="All 2 branches missed.">    if (stval == null) {</span>
<span class="nc" id="L400">      return defaultValue;</span>
    }

    try {
<span class="nc" id="L404">      return Long.parseLong(stval);</span>
<span class="nc" id="L405">    } catch (NumberFormatException e) {</span>
<span class="nc" id="L406">      logger.trace(&quot;&quot;, e);</span>
<span class="nc" id="L407">      return defaultValue;</span>
    }
  }

  /**
   * The Class TokenizerToken.
   */
  private static class TokenizerToken implements Token {

    /** The text. */
<span class="nc" id="L417">    final StringBuilder text = new StringBuilder();</span>

    /** The inner text. */
<span class="nc" id="L420">    final StringBuilder innerText = new StringBuilder();</span>

    /** The name. */
<span class="nc" id="L423">    String name = &quot;&quot;;</span>

    /** The type. */
<span class="nc" id="L426">    int type = Tokenizer.TT_ERROR;</span>

    /** The line. */
    int line;

    /** The col. */
    int col;

    /**
     * Instantiates a new tokenizer token.
     */
<span class="nc" id="L437">    public TokenizerToken() {</span>
<span class="nc" id="L438">      type = Tokenizer.TT_ERROR;</span>
<span class="nc" id="L439">    }</span>

    @Override
    public String getText() {
<span class="nc" id="L443">      return text.toString();</span>
    }

    @Override
    public String getInnerText() {
<span class="nc bnc" id="L448" title="All 2 branches missed.">      return type == Tokenizer.TT_BLOCK ? innerText.toString() : getText();</span>
    }

    @Override
    public String getName() {
<span class="nc" id="L453">      return name;</span>
    }

    @Override
    public int getType() {
<span class="nc" id="L458">      return type;</span>
    }

    @Override
    public int getLine() {
<span class="nc" id="L463">      return line;</span>
    }

    @Override
    public int getCol() {
<span class="nc" id="L468">      return col;</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L473">      return getText();</span>
    }

    /**
     * Assign.
     *
     * @param token the token
     */
    public void assign(TokenizerToken token) {
<span class="nc" id="L482">      this.text.setLength(0);</span>
<span class="nc" id="L483">      this.text.append(token.text);</span>
<span class="nc" id="L484">      this.innerText.setLength(0);</span>
<span class="nc" id="L485">      this.innerText.append(token.innerText);</span>
<span class="nc" id="L486">      this.name = token.name;</span>
<span class="nc" id="L487">      this.type = token.type;</span>
<span class="nc" id="L488">      this.col = token.col;</span>
<span class="nc" id="L489">      this.line = token.line;</span>
<span class="nc" id="L490">    }</span>

    /**
     * Inits the.
     */
    public void init() {
<span class="nc" id="L496">      text.setLength(0);</span>
<span class="nc" id="L497">      innerText.setLength(0);</span>
<span class="nc" id="L498">      name = &quot;&quot;;</span>
<span class="nc" id="L499">    }</span>

  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>