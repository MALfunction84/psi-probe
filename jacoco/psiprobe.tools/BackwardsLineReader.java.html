<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BackwardsLineReader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">psi-probe-core</a> &gt; <a href="index.source.html" class="el_package">psiprobe.tools</a> &gt; <span class="el_source">BackwardsLineReader.java</span></div><h1>BackwardsLineReader.java</h1><pre class="source lang-java linenums">/*
 * Licensed under the GPL License. You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   https://www.gnu.org/licenses/old-licenses/gpl-2.0.html
 *
 * THIS PACKAGE IS PROVIDED &quot;AS IS&quot; AND WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
 * WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE.
 */
package psiprobe.tools;

import java.io.BufferedInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.nio.charset.Charset;
import java.nio.charset.StandardCharsets;

/**
 * Reads lines from &quot;backwards&quot; InputStream. This class facilitates reading files from bottom up.
 *
 * &lt;p&gt;
 * This source code was kindly contributed by Kan Ogawa.
 * &lt;/p&gt;
 */
public class BackwardsLineReader {

  /** The bis. */
  private BufferedInputStream bis;

  /** The skip line feed. */
<span class="nc" id="L33">  private boolean skipLineFeed = true;</span>

  /** The encoding. */
  private String encoding;

  /**
   * Instantiates a new backwards line reader.
   *
   * @param is the is
   */
  public BackwardsLineReader(InputStream is) {
<span class="nc" id="L44">    this(is, null);</span>
<span class="nc" id="L45">  }</span>

  /**
   * Instantiates a new backwards line reader.
   *
   * @param is the is
   * @param encoding the encoding
   */
<span class="nc" id="L53">  public BackwardsLineReader(InputStream is, String encoding) {</span>
<span class="nc" id="L54">    this.bis = new BufferedInputStream(is, 8192);</span>
<span class="nc" id="L55">    this.encoding = encoding;</span>
<span class="nc" id="L56">  }</span>

  /**
   * Read line.
   *
   * @return the string
   *
   * @throws IOException Signals that an I/O exception has occurred.
   */
  public String readLine() throws IOException {
<span class="nc" id="L66">    ByteArrayOutputStream baos = new ByteArrayOutputStream(512);</span>
<span class="nc" id="L67">    boolean empty = false;</span>
    while (true) {
<span class="nc" id="L69">      byte chr = (byte) bis.read();</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">      if (chr == -1) {</span>
        // quit this loop, if the first of the backwards stream is
        // reached
<span class="nc bnc" id="L73" title="All 2 branches missed.">        if (baos.toByteArray().length == 0) {</span>
<span class="nc" id="L74">          empty = true;</span>
        }
        break;
      }
<span class="nc bnc" id="L78" title="All 2 branches missed.">      if (chr == '\n') {</span>
<span class="nc" id="L79">        skipLineFeed = false;</span>
        // quit this loop
<span class="nc" id="L81">        break;</span>
      }
<span class="nc bnc" id="L83" title="All 2 branches missed.">      if (chr == '\r') {</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (skipLineFeed) {</span>
          // quit this loop. if the carriage return only was read
<span class="nc" id="L86">          break;</span>
        }
        // go to next loop, if both the carriage return and
        // the line feed were read
        continue;
      }
<span class="nc" id="L92">      baos.write(chr);</span>
<span class="nc" id="L93">    }</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">    if (!empty) {</span>
<span class="nc" id="L95">      byte[] byteArray = baos.toByteArray();</span>
<span class="nc" id="L96">      reverse(byteArray);</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">      return encoding == null ? new String(byteArray, StandardCharsets.UTF_8)</span>
<span class="nc" id="L98">          : new String(byteArray, Charset.forName(encoding));</span>
    }
    // return null if the end of the stream has been reached
<span class="nc" id="L101">    return null;</span>
  }

  /**
   * Close.
   *
   * @throws IOException Signals that an I/O exception has occurred.
   */
  public void close() throws IOException {
<span class="nc bnc" id="L110" title="All 2 branches missed.">    if (bis != null) {</span>
<span class="nc" id="L111">      bis.close();</span>
    }
<span class="nc" id="L113">  }</span>

  /**
   * Reverse.
   *
   * @param byteArray the byte array
   */
  private void reverse(byte[] byteArray) {
<span class="nc bnc" id="L121" title="All 2 branches missed.">    for (int i = 0; i &lt; byteArray.length / 2; i++) {</span>
<span class="nc" id="L122">      byte temp = byteArray[i];</span>
<span class="nc" id="L123">      byteArray[i] = byteArray[byteArray.length - i - 1];</span>
<span class="nc" id="L124">      byteArray[byteArray.length - i - 1] = temp;</span>
    }
<span class="nc" id="L126">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>