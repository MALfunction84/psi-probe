<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Jdk14LoggerAccessor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">psi-probe-core</a> &gt; <a href="index.source.html" class="el_package">psiprobe.tools.logging.jdk</a> &gt; <span class="el_source">Jdk14LoggerAccessor.java</span></div><h1>Jdk14LoggerAccessor.java</h1><pre class="source lang-java linenums">/*
 * Licensed under the GPL License. You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   https://www.gnu.org/licenses/old-licenses/gpl-2.0.html
 *
 * THIS PACKAGE IS PROVIDED &quot;AS IS&quot; AND WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
 * WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE.
 */
package psiprobe.tools.logging.jdk;

import com.google.common.base.Strings;

import java.lang.reflect.Method;
import java.util.ArrayList;
import java.util.List;

import org.apache.commons.lang3.reflect.MethodUtils;

import psiprobe.tools.logging.DefaultAccessor;
import psiprobe.tools.logging.LogDestination;

/**
 * The Class Jdk14LoggerAccessor.
 */
<span class="fc" id="L27">public class Jdk14LoggerAccessor extends DefaultAccessor {</span>

  /** The context. */
  private boolean context;

  /**
   * Gets the handlers.
   *
   * @return the handlers
   */
  public List&lt;LogDestination&gt; getHandlers() {
<span class="nc" id="L38">    List&lt;LogDestination&gt; handlerAccessors = new ArrayList&lt;&gt;();</span>
    try {
<span class="nc" id="L40">      Object[] handlers = (Object[]) MethodUtils.invokeMethod(getTarget(), &quot;getHandlers&quot;);</span>
<span class="nc bnc" id="L41" title="All 2 branches missed.">      for (int h = 0; h &lt; handlers.length; h++) {</span>
<span class="nc" id="L42">        Object handler = handlers[h];</span>
<span class="nc" id="L43">        Jdk14HandlerAccessor handlerAccessor = wrapHandler(handler, h);</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">        if (handlerAccessor != null) {</span>
<span class="nc" id="L45">          handlerAccessors.add(handlerAccessor);</span>
        }
      }
<span class="nc" id="L48">    } catch (Exception e) {</span>
<span class="nc" id="L49">      logger.error(&quot;{}#handlers inaccessible&quot;, getTarget().getClass().getName(), e);</span>
<span class="nc" id="L50">    }</span>
<span class="nc" id="L51">    return handlerAccessors;</span>
  }

  /**
   * Checks if is context.
   *
   * @return true, if is context
   */
  public boolean isContext() {
<span class="nc" id="L60">    return context;</span>
  }

  /**
   * Sets the context.
   *
   * @param context the new context
   */
  public void setContext(boolean context) {
<span class="nc" id="L69">    this.context = context;</span>
<span class="nc" id="L70">  }</span>

  /**
   * Checks if is root.
   *
   * @return true, if is root
   */
  public boolean isRoot() {
<span class="nc bnc" id="L78" title="All 4 branches missed.">    return Strings.isNullOrEmpty(getName()) || isJuliRoot();</span>
  }

  /**
   * Checks if is juli root.
   *
   * @return true, if is juli root
   */
  public boolean isJuliRoot() {
<span class="nc" id="L87">    return &quot;org.apache.juli.ClassLoaderLogManager$RootLogger&quot;.equals(getTargetClass());</span>
  }

  /**
   * Gets the name.
   *
   * @return the name
   */
  public String getName() {
<span class="nc" id="L96">    return (String) getProperty(getTarget(), &quot;name&quot;, null);</span>
  }

  /**
   * Gets the handler.
   *
   * @param logIndex the log index
   *
   * @return the handler
   */
  public Jdk14HandlerAccessor getHandler(String logIndex) {
<span class="nc" id="L107">    int index = 0;</span>
    try {
<span class="nc" id="L109">      index = Integer.parseInt(logIndex);</span>
<span class="nc" id="L110">    } catch (Exception e) {</span>
<span class="nc" id="L111">      logger.info(&quot;Could not parse integer from: {}.  Assuming 0.&quot;, logIndex);</span>
<span class="nc" id="L112">      logger.trace(&quot;&quot;, e);</span>
<span class="nc" id="L113">    }</span>
<span class="nc" id="L114">    return getHandler(index);</span>
  }

  /**
   * Gets the handler.
   *
   * @param index the index
   *
   * @return the handler
   */
  public Jdk14HandlerAccessor getHandler(int index) {
    try {
<span class="nc" id="L126">      Object[] handlers = (Object[]) MethodUtils.invokeMethod(getTarget(), &quot;getHandlers&quot;);</span>
<span class="nc" id="L127">      return wrapHandler(handlers[index], index);</span>
<span class="nc" id="L128">    } catch (Exception e) {</span>
<span class="nc" id="L129">      logger.error(&quot;{}#handlers inaccessible&quot;, getTarget().getClass().getName(), e);</span>
    }
<span class="nc" id="L131">    return null;</span>
  }

  /**
   * Gets the level.
   *
   * @return the level
   */
  public String getLevel() {
    try {
<span class="nc" id="L141">      Object level = null;</span>
<span class="nc" id="L142">      Object target = getTarget();</span>
<span class="nc bnc" id="L143" title="All 4 branches missed.">      while (level == null &amp;&amp; target != null) {</span>
<span class="nc" id="L144">        level = getLevelInternal(target);</span>
<span class="nc" id="L145">        target = MethodUtils.invokeMethod(target, &quot;getParent&quot;);</span>
      }
<span class="nc bnc" id="L147" title="All 4 branches missed.">      if (level == null &amp;&amp; isJuliRoot()) {</span>
<span class="nc" id="L148">        return &quot;INFO&quot;;</span>
      }
<span class="nc" id="L150">      return (String) MethodUtils.invokeMethod(level, &quot;getName&quot;);</span>
<span class="nc" id="L151">    } catch (Exception e) {</span>
<span class="nc" id="L152">      logger.error(&quot;{}#getLevel() failed&quot;, getTarget().getClass().getName(), e);</span>
    }
<span class="nc" id="L154">    return null;</span>
  }

  /**
   * Sets the level.
   *
   * @param newLevelStr the new level
   */
  public void setLevel(String newLevelStr) {
    try {
<span class="nc" id="L164">      Class&lt;?&gt; levelClass =</span>
<span class="nc" id="L165">          getTarget().getClass().getClassLoader().loadClass(&quot;java.util.logging.Level&quot;);</span>
<span class="nc" id="L166">      Method parse = MethodUtils.getAccessibleMethod(levelClass, &quot;parse&quot;, String.class);</span>
<span class="nc" id="L167">      Object newLevel = parse.invoke(null, newLevelStr);</span>
<span class="nc" id="L168">      MethodUtils.invokeMethod(getTarget(), &quot;setLevel&quot;, newLevel);</span>
<span class="nc" id="L169">    } catch (Exception e) {</span>
<span class="nc" id="L170">      logger.error(&quot;{}#setLevel('{}') failed&quot;, getTarget().getClass().getName(), newLevelStr, e);</span>
<span class="nc" id="L171">    }</span>
<span class="nc" id="L172">  }</span>

  /**
   * Gets the level internal.
   *
   * @param target the target
   *
   * @return the level internal
   *
   * @throws Exception the exception
   */
  private Object getLevelInternal(Object target) throws Exception {
<span class="nc" id="L184">    return MethodUtils.invokeMethod(target, &quot;getLevel&quot;);</span>
  }

  /**
   * Wrap handler.
   *
   * @param handler the handler
   * @param index the index
   *
   * @return the jdk14 handler accessor
   */
  private Jdk14HandlerAccessor wrapHandler(Object handler, int index) {
    try {
<span class="nc bnc" id="L197" title="All 2 branches missed.">      if (handler == null) {</span>
<span class="nc" id="L198">        throw new IllegalArgumentException(&quot;handler is null&quot;);</span>
      }
<span class="nc" id="L200">      Jdk14HandlerAccessor handlerAccessor = null;</span>
<span class="nc" id="L201">      String className = handler.getClass().getName();</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">      if (&quot;org.apache.juli.FileHandler&quot;.equals(className)) {</span>
<span class="nc" id="L203">        handlerAccessor = new JuliHandlerAccessor();</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">      } else if (&quot;java.util.logging.ConsoleHandler&quot;.equals(className)) {</span>
<span class="nc" id="L205">        handlerAccessor = new Jdk14HandlerAccessor();</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">      } else if (&quot;java.util.logging.FileHandler&quot;.equals(className)) {</span>
<span class="nc" id="L207">        handlerAccessor = new Jdk14FileHandlerAccessor();</span>
      }

<span class="nc bnc" id="L210" title="All 2 branches missed.">      if (handlerAccessor != null) {</span>
<span class="nc" id="L211">        handlerAccessor.setLoggerAccessor(this);</span>
<span class="nc" id="L212">        handlerAccessor.setTarget(handler);</span>
<span class="nc" id="L213">        handlerAccessor.setIndex(Integer.toString(index));</span>
<span class="nc" id="L214">        handlerAccessor.setApplication(getApplication());</span>
      }
<span class="nc" id="L216">      return handlerAccessor;</span>
<span class="nc" id="L217">    } catch (Exception e) {</span>
<span class="nc" id="L218">      logger.error(&quot;Could not wrap handler: '{}'&quot;, handler, e);</span>
    }
<span class="nc" id="L220">    return null;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>