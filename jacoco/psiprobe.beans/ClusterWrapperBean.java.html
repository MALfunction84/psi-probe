<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ClusterWrapperBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">psi-probe-core</a> &gt; <a href="index.source.html" class="el_package">psiprobe.beans</a> &gt; <span class="el_source">ClusterWrapperBean.java</span></div><h1>ClusterWrapperBean.java</h1><pre class="source lang-java linenums">/*
 * Licensed under the GPL License. You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   https://www.gnu.org/licenses/old-licenses/gpl-2.0.html
 *
 * THIS PACKAGE IS PROVIDED &quot;AS IS&quot; AND WITHOUT ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
 * WITHOUT LIMITATION, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE.
 */
package psiprobe.beans;

import java.lang.management.ManagementFactory;
import java.util.Set;

import javax.management.MBeanServer;
import javax.management.MalformedObjectNameException;
import javax.management.ObjectInstance;
import javax.management.ObjectName;

import psiprobe.model.jmx.AsyncClusterSender;
import psiprobe.model.jmx.Cluster;
import psiprobe.model.jmx.ClusterSender;
import psiprobe.model.jmx.PooledClusterSender;
import psiprobe.model.jmx.SyncClusterSender;
import psiprobe.tools.JmxTools;

/**
 * The Class ClusterWrapperBean.
 */
<span class="fc" id="L31">public class ClusterWrapperBean {</span>

  /**
   * Gets the cluster.
   *
   * @param serverName the server name
   * @param hostName the host name
   * @param loadMembers the load members
   *
   * @return the cluster
   *
   * @throws MalformedObjectNameException the malformed object name exception
   */
  public Cluster getCluster(String serverName, String hostName, boolean loadMembers)
      throws MalformedObjectNameException {

<span class="nc" id="L47">    Cluster cluster = null;</span>

<span class="nc" id="L49">    MBeanServer mbeanServer = ManagementFactory.getPlatformMBeanServer();</span>
<span class="nc" id="L50">    ObjectName objectNameMembership =</span>
        new ObjectName(serverName + &quot;:type=ClusterMembership,host=&quot; + hostName);
<span class="nc" id="L52">    ObjectName objectNameReceiver =</span>
        new ObjectName(serverName + &quot;:type=ClusterReceiver,host=&quot; + hostName);
<span class="nc" id="L54">    ObjectName objectNameSender =</span>
        new ObjectName(serverName + &quot;:type=ClusterSender,host=&quot; + hostName);

    /*
     * should be just one set, this is just to find out if this instance is cluster-enabled and the
     * cluster supports JMX
     */
<span class="nc" id="L61">    Set&lt;ObjectInstance&gt; clusters =</span>
<span class="nc" id="L62">        mbeanServer.queryMBeans(new ObjectName(&quot;*:type=Cluster,host=&quot; + hostName), null);</span>
<span class="nc" id="L63">    Set&lt;ObjectInstance&gt; membership = mbeanServer.queryMBeans(objectNameMembership, null);</span>
<span class="nc bnc" id="L64" title="All 8 branches missed.">    if (clusters != null &amp;&amp; !clusters.isEmpty() &amp;&amp; membership != null &amp;&amp; !membership.isEmpty()) {</span>
<span class="nc" id="L65">      ObjectName objectNameCluster = clusters.iterator().next().getObjectName();</span>
<span class="nc" id="L66">      cluster = new Cluster();</span>

<span class="nc" id="L68">      cluster.setName(JmxTools.getStringAttr(mbeanServer, objectNameCluster, &quot;clusterName&quot;));</span>
<span class="nc" id="L69">      cluster.setInfo(JmxTools.getStringAttr(mbeanServer, objectNameCluster, &quot;info&quot;));</span>
<span class="nc" id="L70">      cluster.setManagerClassName(</span>
<span class="nc" id="L71">          JmxTools.getStringAttr(mbeanServer, objectNameCluster, &quot;managerClassName&quot;));</span>

<span class="nc" id="L73">      cluster</span>
<span class="nc" id="L74">          .setMcastAddress(JmxTools.getStringAttr(mbeanServer, objectNameMembership, &quot;mcastAddr&quot;));</span>
<span class="nc" id="L75">      cluster.setMcastBindAddress(</span>
<span class="nc" id="L76">          JmxTools.getStringAttr(mbeanServer, objectNameMembership, &quot;mcastBindAddress&quot;));</span>
<span class="nc" id="L77">      cluster.setMcastClusterDomain(</span>
<span class="nc" id="L78">          JmxTools.getStringAttr(mbeanServer, objectNameMembership, &quot;mcastClusterDomain&quot;));</span>
<span class="nc" id="L79">      cluster.setMcastDropTime(</span>
<span class="nc" id="L80">          JmxTools.getLongAttr(mbeanServer, objectNameMembership, &quot;mcastDropTime&quot;));</span>
<span class="nc" id="L81">      cluster.setMcastFrequency(</span>
<span class="nc" id="L82">          JmxTools.getLongAttr(mbeanServer, objectNameMembership, &quot;mcastFrequency&quot;));</span>
<span class="nc" id="L83">      cluster.setMcastPort(JmxTools.getIntAttr(mbeanServer, objectNameMembership, &quot;mcastPort&quot;));</span>
<span class="nc" id="L84">      cluster.setMcastSoTimeout(</span>
<span class="nc" id="L85">          JmxTools.getIntAttr(mbeanServer, objectNameMembership, &quot;mcastSoTimeout&quot;));</span>
<span class="nc" id="L86">      cluster.setMcastTtl(JmxTools.getIntAttr(mbeanServer, objectNameMembership, &quot;mcastTTL&quot;));</span>

<span class="nc" id="L88">      cluster.setTcpListenAddress(</span>
<span class="nc" id="L89">          JmxTools.getStringAttr(mbeanServer, objectNameReceiver, &quot;tcpListenAddress&quot;));</span>
<span class="nc" id="L90">      cluster</span>
<span class="nc" id="L91">          .setTcpListenPort(JmxTools.getIntAttr(mbeanServer, objectNameReceiver, &quot;tcpListenPort&quot;));</span>
<span class="nc" id="L92">      cluster.setNrOfMsgsReceived(</span>
<span class="nc" id="L93">          JmxTools.getLongAttr(mbeanServer, objectNameReceiver, &quot;nrOfMsgsReceived&quot;));</span>
<span class="nc" id="L94">      cluster.setTotalReceivedBytes(</span>
<span class="nc" id="L95">          JmxTools.getLongAttr(mbeanServer, objectNameReceiver, &quot;totalReceivedBytes&quot;));</span>
      // cluster.setTcpSelectorTimeout(
      // JmxTools.getLongAttr(mbeanServer, objectNameReceiver, &quot;tcpSelectorTimeout&quot;));
      // cluster.setTcpThreadCount(
      // JmxTools.getIntAttr(mbeanServer, objectNameReceiver, &quot;tcpThreadCount&quot;));

<span class="nc" id="L101">      cluster</span>
<span class="nc" id="L102">          .setSenderAckTimeout(JmxTools.getLongAttr(mbeanServer, objectNameSender, &quot;ackTimeout&quot;));</span>
<span class="nc" id="L103">      cluster.setSenderAutoConnect(</span>
<span class="nc" id="L104">          JmxTools.getBooleanAttr(mbeanServer, objectNameSender, &quot;autoConnect&quot;));</span>
<span class="nc" id="L105">      cluster.setSenderFailureCounter(</span>
<span class="nc" id="L106">          JmxTools.getLongAttr(mbeanServer, objectNameSender, &quot;failureCounter&quot;));</span>
<span class="nc" id="L107">      cluster.setSenderNrOfRequests(</span>
<span class="nc" id="L108">          JmxTools.getLongAttr(mbeanServer, objectNameSender, &quot;nrOfRequests&quot;));</span>
<span class="nc" id="L109">      cluster.setSenderReplicationMode(</span>
<span class="nc" id="L110">          JmxTools.getStringAttr(mbeanServer, objectNameSender, &quot;replicationMode&quot;));</span>
<span class="nc" id="L111">      cluster</span>
<span class="nc" id="L112">          .setSenderTotalBytes(JmxTools.getLongAttr(mbeanServer, objectNameSender, &quot;totalBytes&quot;));</span>

<span class="nc bnc" id="L114" title="All 2 branches missed.">      if (loadMembers) {</span>
<span class="nc" id="L115">        ObjectName[] senders = (ObjectName[]) JmxTools.getAttribute(mbeanServer, objectNameSender,</span>
            &quot;senderObjectNames&quot;);
<span class="nc bnc" id="L117" title="All 2 branches missed.">        for (ObjectName objectNameLocalSender : senders) {</span>
          ClusterSender sender;

<span class="nc bnc" id="L120" title="All 2 branches missed.">          if (&quot;pooled&quot;.equals(cluster.getSenderReplicationMode())) {</span>
<span class="nc" id="L121">            sender = new PooledClusterSender();</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">          } else if (&quot;synchronous&quot;.equals(cluster.getSenderReplicationMode())) {</span>
<span class="nc" id="L123">            sender = new SyncClusterSender();</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">          } else if (&quot;asynchronous&quot;.equals(cluster.getSenderReplicationMode())</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">              || &quot;fastasyncqueue&quot;.equals(cluster.getSenderReplicationMode())) {</span>
<span class="nc" id="L126">            sender = new AsyncClusterSender();</span>
          } else {
<span class="nc" id="L128">            sender = new ClusterSender();</span>
          }

<span class="nc" id="L131">          sender.setAddress(JmxTools.getStringAttr(mbeanServer, objectNameLocalSender, &quot;address&quot;));</span>
<span class="nc" id="L132">          sender.setPort(JmxTools.getIntAttr(mbeanServer, objectNameLocalSender, &quot;port&quot;));</span>

<span class="nc" id="L134">          sender.setAvgMessageSize(</span>
<span class="nc" id="L135">              JmxTools.getLongAttr(mbeanServer, objectNameLocalSender, &quot;avgMessageSize&quot;, -1));</span>
<span class="nc" id="L136">          sender.setAvgProcessingTime(</span>
<span class="nc" id="L137">              JmxTools.getLongAttr(mbeanServer, objectNameLocalSender, &quot;avgProcessingTime&quot;, -1));</span>

<span class="nc" id="L139">          sender.setConnectCounter(</span>
<span class="nc" id="L140">              JmxTools.getLongAttr(mbeanServer, objectNameLocalSender, &quot;connectCounter&quot;));</span>
<span class="nc" id="L141">          sender.setDisconnectCounter(</span>
<span class="nc" id="L142">              JmxTools.getLongAttr(mbeanServer, objectNameLocalSender, &quot;disconnectCounter&quot;));</span>
<span class="nc" id="L143">          sender.setConnected(</span>
<span class="nc" id="L144">              JmxTools.getBooleanAttr(mbeanServer, objectNameLocalSender, &quot;connected&quot;));</span>
<span class="nc" id="L145">          sender.setKeepAliveTimeout(</span>
<span class="nc" id="L146">              JmxTools.getLongAttr(mbeanServer, objectNameLocalSender, &quot;keepAliveTimeout&quot;));</span>
<span class="nc" id="L147">          sender.setNrOfRequests(</span>
<span class="nc" id="L148">              JmxTools.getLongAttr(mbeanServer, objectNameLocalSender, &quot;nrOfRequests&quot;));</span>
<span class="nc" id="L149">          sender.setTotalBytes(</span>
<span class="nc" id="L150">              JmxTools.getLongAttr(mbeanServer, objectNameLocalSender, &quot;totalBytes&quot;));</span>
<span class="nc" id="L151">          sender.setResend(JmxTools.getBooleanAttr(mbeanServer, objectNameLocalSender, &quot;resend&quot;));</span>
<span class="nc" id="L152">          sender.setSuspect(JmxTools.getBooleanAttr(mbeanServer, objectNameLocalSender, &quot;suspect&quot;));</span>

<span class="nc bnc" id="L154" title="All 2 branches missed.">          if (sender instanceof PooledClusterSender) {</span>
<span class="nc" id="L155">            ((PooledClusterSender) sender).setMaxPoolSocketLimit(</span>
<span class="nc" id="L156">                JmxTools.getIntAttr(mbeanServer, objectNameLocalSender, &quot;maxPoolSocketLimit&quot;));</span>
          }

<span class="nc bnc" id="L159" title="All 2 branches missed.">          if (sender instanceof SyncClusterSender) {</span>
<span class="nc" id="L160">            SyncClusterSender syncSender = (SyncClusterSender) sender;</span>
<span class="nc" id="L161">            syncSender.setDataFailureCounter(</span>
<span class="nc" id="L162">                JmxTools.getLongAttr(mbeanServer, objectNameLocalSender, &quot;dataFailureCounter&quot;));</span>
<span class="nc" id="L163">            syncSender.setDataResendCounter(</span>
<span class="nc" id="L164">                JmxTools.getLongAttr(mbeanServer, objectNameLocalSender, &quot;dataResendCounter&quot;));</span>
<span class="nc" id="L165">            syncSender.setSocketOpenCounter(</span>
<span class="nc" id="L166">                JmxTools.getIntAttr(mbeanServer, objectNameLocalSender, &quot;socketOpenCounter&quot;));</span>
<span class="nc" id="L167">            syncSender.setSocketCloseCounter(</span>
<span class="nc" id="L168">                JmxTools.getIntAttr(mbeanServer, objectNameLocalSender, &quot;socketCloseCounter&quot;));</span>
<span class="nc" id="L169">            syncSender.setSocketOpenFailureCounter(JmxTools.getIntAttr(mbeanServer,</span>
                objectNameLocalSender, &quot;socketOpenFailureCounter&quot;));
          }

<span class="nc bnc" id="L173" title="All 2 branches missed.">          if (sender instanceof AsyncClusterSender) {</span>
<span class="nc" id="L174">            AsyncClusterSender asyncSender = (AsyncClusterSender) sender;</span>
<span class="nc" id="L175">            asyncSender.setInQueueCounter(</span>
<span class="nc" id="L176">                JmxTools.getLongAttr(mbeanServer, objectNameLocalSender, &quot;inQueueCounter&quot;));</span>
<span class="nc" id="L177">            asyncSender.setOutQueueCounter(</span>
<span class="nc" id="L178">                JmxTools.getLongAttr(mbeanServer, objectNameLocalSender, &quot;outQueueCounter&quot;));</span>
<span class="nc" id="L179">            asyncSender</span>
<span class="nc" id="L180">                .setQueueSize(JmxTools.getIntAttr(mbeanServer, objectNameLocalSender, &quot;queueSize&quot;));</span>
<span class="nc" id="L181">            asyncSender.setQueuedNrOfBytes(</span>
<span class="nc" id="L182">                JmxTools.getLongAttr(mbeanServer, objectNameLocalSender, &quot;queuedNrOfBytes&quot;));</span>
          }
<span class="nc" id="L184">          cluster.getMembers().add(sender);</span>
        }
      }
    }
<span class="nc" id="L188">    return cluster;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>